---
- name: "üöÄ Kibana Installation and Configuration"
  block:
    # Initialize deployment variables
    - name: Initialize Kibana variables
      include_tasks: init-variables.yml

    # Skip hosts without Kibana installation flag
    - name: Skip hosts without Kibana configuration
      meta: end_host
      when: 
        - not install_kibana | default(false)
        - "'BDA' not in group_names"

    # Create directory structure
    - name: Create Kibana directory structure
      include_tasks: create-directories.yml
      when: install_kibana | default(false)

    # Setup SSL certificates for Kibana
    - name: Setup SSL certificates for Kibana
      include_tasks: setup-ssl.yml
      when: 
        - install_kibana | default(false)
        - kibana_enable_ssl | default(true)

    # Generate Kibana configuration
    - name: Generate Kibana configuration
      include_tasks: configure-kibana.yml
      when: install_kibana | default(false)

    # Setup Docker Compose
    - name: Setup Docker Compose for Kibana
      include_tasks: setup-docker-compose.yml
      when: install_kibana | default(false)

    # Set kibana_system password
    - name: Set kibana_system password
      include_tasks: set-kibana-password.yml
      when: install_kibana | default(false)

    # Deploy Kibana
    - name: Deploy Kibana using Docker Compose
      include_tasks: kibana-docker-deploy.yml
      when: install_kibana | default(false)

  rescue:
    - name: Handle Kibana installation failure
      debug:
        msg: |
          ‚ùå Kibana installation failed on {{ inventory_hostname }}!
          
          üîç Diagnostic Steps:
          1. Check configuration files: ls -la {{ kibana_docker_path }}/config/
          2. Check docker-compose syntax: cd {{ kibana_docker_path }} && docker-compose config
          3. Check container logs: docker logs kibana-{{ inventory_hostname }}
          4. Check Elasticsearch connectivity: curl -k https://{{ hostvars[inventory_hostname].node_hostname }}:9200
          5. Check system resources: free -h && df -h {{ kibana_docker_path }}

  when: "'BDA' in group_names"
  tags: [cluster, simple, kibana]