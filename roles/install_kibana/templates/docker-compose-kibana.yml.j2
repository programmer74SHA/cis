# roles/install_kibana/templates/docker-compose-kibana.yml.j2
# UPDATED: Using custom Docker bridge network

version: '3.8'

services:
  kibana:
    image: {{ kibana_docker_image | default('docker.apk-group.net/kibana') }}:{{ kibana_version | default('8.18.2') }}
    container_name: kibana-{{ inventory_hostname }}
    hostname: {{ hostvars[inventory_hostname].node_hostname }}
    restart: unless-stopped
    
    # Connect to custom Docker bridge network
    networks:
      - {{ docker_network_name }}
    
    # Expose Kibana port on host interface
    ports:
      - "{{ hostvars[inventory_hostname].ansible_host }}:5601:5601"
    
    environment:
      # Elasticsearch Configuration - using hostname
      - "ELASTICSEARCH_HOSTS=https://{{ hostvars[inventory_hostname].node_hostname }}:9200"
{%- if es_service_token is defined and es_service_token != '' %}
      - "ELASTICSEARCH_SERVICEACCOUNTTOKEN={{ es_service_token }}"
{%- else %}
      - "ELASTICSEARCH_USERNAME={{ kibana_elasticsearch_username | default('elastic') }}"
      - "ELASTICSEARCH_PASSWORD={{ kibana_elasticsearch_password | default('YourVerySecureElasticsearchPassword123!') }}"
{%- endif %}
      - "ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=/usr/share/kibana/config/certs/ca/ca.crt"
      - "ELASTICSEARCH_SSL_VERIFICATIONMODE=certificate"
      
      # Server Configuration - bind to all interfaces
      - "SERVER_HOST=0.0.0.0"
      - "SERVER_PORT=5601"
      - "SERVER_NAME={{ inventory_hostname }}-kibana"
      - "SERVER_PUBLICBASEURL=https://{{ hostvars[inventory_hostname].node_hostname }}:5601"
      
      # Server SSL Configuration
      - "SERVER_SSL_ENABLED=true"
      - "SERVER_SSL_KEY=/usr/share/kibana/config/certs/kibana/kibana.key"
      - "SERVER_SSL_CERTIFICATE=/usr/share/kibana/config/certs/kibana/kibana.crt"
      
      # Security Keys (generated random keys)
      - "XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=7946e75bc0cad7f510d933d288ead678"
      - "XPACK_REPORTING_ENCRYPTIONKEY=bd7bc65d6208bb27cb52b035a25d0e72"
      - "XPACK_SECURITY_ENCRYPTIONKEY=2f80b83bdec5bdab7d5e9c09f67c1141"
      
      # Logging Configuration
      - "LOGGING_ROOT_LEVEL=info"
      
      # Performance Settings
      - "NODE_OPTIONS=--max-old-space-size=2048"
      
      # Telemetry Settings
      - "TELEMETRY_OPTIN=false"
      - "TELEMETRY_ALLOWCHANGINGOPTINSTATUS=false"

    volumes:
      # Data and logs
      - "{{ kibana_data_path | default('/usr/share/siem/kibana/data') }}:/usr/share/kibana/data:Z"
      - "{{ kibana_logs_path | default('/usr/share/siem/kibana/logs') }}:/usr/share/kibana/logs:Z"
      
      # Configuration
      - "{{ kibana_config_path | default('/usr/share/siem/kibana/config') }}/kibana.yml:/usr/share/kibana/config/kibana.yml:ro,Z"
      
      # SSL Certificates
      - "{{ kibana_certs_path | default('/usr/share/siem/kibana/certs') }}:/usr/share/kibana/config/certs:ro,Z"

    healthcheck:
      test: 
        - "CMD-SHELL"
        - "curl -f -k https://127.0.0.1:5601/api/status || exit 1"
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 120s

    # Run as kibana user
    user: "1000:1000"
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

    # Ensure container restarts unless stopped
    restart: unless-stopped

# Custom Docker bridge network with unique subnet
networks:
  {{ docker_network_name }}:
    name: {{ docker_network_name }}
    driver: bridge
    ipam:
      config:
        - subnet: {{ docker_network_subnet }}