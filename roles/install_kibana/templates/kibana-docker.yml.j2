# roles/install_kibana/templates/kibana-docker.yml.j2
# FIXED: Connect to localhost Elasticsearch on BDA host

# =================== Server Configuration ===================
server.host: "0.0.0.0"
server.port: 5601
server.name: "{{ inventory_hostname }}-kibana"
server.publicBaseUrl: "https://{{ hostvars[inventory_hostname].node_hostname }}:5601"

# SSL Configuration for Kibana server
server.ssl.enabled: true
server.ssl.key: /usr/share/kibana/config/certs/kibana/kibana.key
server.ssl.certificate: /usr/share/kibana/config/certs/kibana/kibana.crt

# =================== Logging Configuration ===================
logging:
  root:
    level: info
    appenders:
      - kibana-log
  appenders:
    kibana-log:
      type: rolling-file
      fileName: /usr/share/kibana/logs/kibana.log
      policy:
        type: time-interval
        interval: 24h
      layout:
        type: json

# Process ID file
pid.file: /usr/share/kibana/data/kibana.pid

# =================== Elasticsearch Configuration ===================
# FIXED: Connect to BDA host's Elasticsearch using host.docker.internal or 127.0.0.1
# Since both containers are on the same host, use the host network
elasticsearch.hosts: ['https://{{ hostvars[inventory_hostname].node_hostname }}:9200']
elasticsearch.ssl.certificateAuthorities: [/usr/share/kibana/config/certs/ca/ca.crt]
elasticsearch.ssl.verificationMode: none

{% if es_service_token is defined %}
# Use service account token for authentication
elasticsearch.serviceAccountToken: {{ es_service_token }}
{% else %}
# Fallback to username/password authentication
elasticsearch.username: "{{ kibana_elasticsearch_username | default('elastic') }}"
elasticsearch.password: "{{ kibana_elasticsearch_password | default('YourVerySecureElasticsearchPassword123!') }}"
{% endif %}

# Connection timeout settings
elasticsearch.pingTimeout: 30000
elasticsearch.requestTimeout: 120000

# =================== Security Configuration ===================
# Encryption keys for various Kibana features
xpack.encryptedSavedObjects.encryptionKey: 7946e75bc0cad7f510d933d288ead678
xpack.reporting.encryptionKey: bd7bc65d6208bb27cb52b035a25d0e72
xpack.security.encryptionKey: 2f80b83bdec5bdab7d5e9c09f67c1141

# =================== Monitoring Configuration ===================
# Disable cross-cluster search for monitoring
monitoring.ui.ccs.enabled: false

# =================== Performance Configuration ===================
# Request timeout for Elasticsearch operations
elasticsearch.requestTimeout: 120000

# =================== Telemetry Configuration ===================
# Disable telemetry for security
telemetry.allowChangingOptInStatus: false
telemetry.optIn: false

# =================== End of Configuration ===================

# Configuration Summary:
# - Generated: {{ ansible_date_time.iso8601 }}
# - Host: {{ inventory_hostname }} ({{ hostvars[inventory_hostname].node_hostname }})
# - Elasticsearch: {{ hostvars[inventory_hostname].node_hostname }}:9200
# - SSL: Enabled with custom certificates
# - Authentication: {{ 'Service Token' if es_service_token is defined else 'Username/Password' }}