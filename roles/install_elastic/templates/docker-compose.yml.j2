version: '3.8'

services:
  elasticsearch:
    image: {{ elasticsearch_docker_image }}:{{ es_version }}
    container_name: elasticsearch-{{ inventory_hostname }}
    hostname: elasticsearch-{{ inventory_hostname }}
    restart: unless-stopped
    
    environment:
      node.name: "{{ inventory_hostname }}"
      cluster.name: "{{ es_cluster_name | default('siem-cluster') }}"
      network.host: "0.0.0.0"
      http.port: "9200"
      transport.port: "9300"
      discovery.seed_hosts: "{{ elasticsearch_seed_hosts }}"
      cluster.initial_master_nodes: "{{ elasticsearch_master_nodes }}"
      bootstrap.memory_lock: "true"
      ES_JAVA_OPTS: "-Xms{{ es_heap_size | default('1g') }} -Xmx{{ es_heap_size | default('1g') }}"
      xpack.security.enabled: "true"
{%- set roles_list = [] %}
{%- for role in elasticsearch_node_roles %}
{%- set _ = roles_list.append('"' + role + '"') %}
{%- endfor %}
      node.roles: "[{{ roles_list | join(',') }}]"
      cluster.max_shards_per_node: "2000"
      action.auto_create_index: "true"
{%- if es_enable_http_ssl | default(true) %}
      xpack.security.http.ssl.enabled: "true"
      xpack.security.http.ssl.key: "/usr/share/elasticsearch/config/certs/{{ inventory_hostname }}/{{ inventory_hostname }}.key"
      xpack.security.http.ssl.certificate: "/usr/share/elasticsearch/config/certs/{{ inventory_hostname }}/{{ inventory_hostname }}.crt"
      xpack.security.http.ssl.certificate_authorities: "/usr/share/elasticsearch/config/certs/ca/ca.crt"
{%- endif %}
{%- if es_enable_transport_ssl | default(true) %}
      xpack.security.transport.ssl.enabled: "true"
      xpack.security.transport.ssl.key: "/usr/share/elasticsearch/config/certs/{{ inventory_hostname }}/{{ inventory_hostname }}.key"
      xpack.security.transport.ssl.certificate: "/usr/share/elasticsearch/config/certs/{{ inventory_hostname }}/{{ inventory_hostname }}.crt"
      xpack.security.transport.ssl.certificate_authorities: "/usr/share/elasticsearch/config/certs/ca/ca.crt"
{%- endif %}
{%- if es_api_basic_auth_password is defined %}
      ELASTIC_PASSWORD: "{{ es_api_basic_auth_password }}"
{%- endif %}

    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

    ports:
      - "{{ ansible_default_ipv4.address }}:9200:9200"
      - "{{ ansible_default_ipv4.address }}:9300:9300"

    volumes:
      - "{{ elasticsearch_data_path }}:/usr/share/elasticsearch/data:Z"
      - "{{ elasticsearch_logs_path }}:/usr/share/elasticsearch/logs:Z"
      - "{{ elasticsearch_config_path }}/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro,Z"
      - "{{ elasticsearch_config_path }}/jvm.options:/usr/share/elasticsearch/config/jvm.options:ro,Z"
      - "{{ es_ssl_certificate_path }}:/usr/share/elasticsearch/config/certs:ro,Z"

    networks:
      - elastic

    healthcheck:
{%- if es_enable_http_ssl | default(true) and es_api_basic_auth_password is defined %}
      test: ["CMD-SHELL", "curl -f -k -u {{ es_api_basic_auth_username | default('elastic') }}:{{ es_api_basic_auth_password }} https://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=30s || exit 1"]
{%- else %}
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
{%- endif %}
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 120s

    user: "1000:1000"

networks:
  elastic:
    external: true