---
- name: Create Elasticsearch directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  loop:
    - "{{ elasticsearch_docker_path }}"
    - "{{ certs_base_path }}"

- name: Detect OS family
  set_fact:
    os_family: "{{ ansible_os_family | lower }}"

- name: Start Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Add current user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes
  ignore_errors: true

- name: Test Docker installation
  shell: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  debug:
    msg: "Docker installed: {{ docker_version.stdout }}"

# UPDATED: Create custom Docker bridge network for this host
- name: Check if Docker network exists
  shell: docker network ls --format "{{ '{{' }}.Name{{ '}}' }}" | grep -x "{{ docker_network_name }}"
  register: network_check
  changed_when: false
  failed_when: false

- name: Remove existing Docker network if subnet doesn't match
  shell: |
    CURRENT_SUBNET=$(docker network inspect {{ docker_network_name }} --format "{{ '{{' }}range .IPAM.Config{{ '}}' }}{{ '{{' }}.Subnet{{ '}}' }}{{ '{{' }}end{{ '}}' }}")
    if [ "$CURRENT_SUBNET" != "{{ docker_network_subnet }}" ]; then
      docker network rm {{ docker_network_name }}
      exit 0
    else
      exit 1
    fi
  when: network_check.rc == 0
  register: network_removed
  failed_when: false
  changed_when: network_removed.rc == 0

- name: Create custom Docker bridge network for Elasticsearch
  docker_network:
    name: "{{ docker_network_name }}"
    driver: bridge
    ipam_config:
      - subnet: "{{ docker_network_subnet }}"
    state: present
  register: network_creation

- name: Display Docker network information
  debug:
    msg: |
      🌐 Docker Network Configuration
      ==============================
      Network Name: {{ docker_network_name }}
      Subnet: {{ docker_network_subnet }}
      Status: {{ 'Created' if network_creation.changed else 'Already exists' }}

# System configuration
- name: Configure kernel parameters for Elasticsearch
  block:
    - name: Check current vm.max_map_count
      shell: sysctl -n vm.max_map_count
      register: current_max_map_count
      changed_when: false

    - name: Set vm.max_map_count using shell command
      shell: echo 262144 > /proc/sys/vm/max_map_count
      when: current_max_map_count.stdout != "262144"

    - name: Make vm.max_map_count persistent
      lineinfile:
        path: /etc/sysctl.conf
        regexp: '^vm\.max_map_count'
        line: 'vm.max_map_count=262144'
        create: yes
      when: current_max_map_count.stdout != "262144"

    - name: Set vm.swappiness
      shell: echo 1 > /proc/sys/vm/swappiness

    - name: Make vm.swappiness persistent
      lineinfile:
        path: /etc/sysctl.conf
        regexp: '^vm\.swappiness'
        line: 'vm.swappiness=1'
        create: yes

- name: Configure system limits for Elasticsearch
  blockinfile:
    path: /etc/security/limits.conf
    block: |
      # Elasticsearch limits
      * soft nofile 65536
      * hard nofile 65536
      * soft nproc 4096
      * hard nproc 4096
      * soft memlock unlimited
      * hard memlock unlimited
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Elasticsearch limits"

- name: Disable swap temporarily
  command: swapoff -a
  ignore_errors: true

- name: Display system configuration status
  debug:
    msg: |
      ✅ System Configuration Completedoc
      ==============================
      - Docker: {{ docker_version.stdout }}
      - Network: {{ docker_network_name }} ({{ docker_network_subnet }})
      - Kernel: vm.max_map_count set to 262144
      - Limits: File and memory limits configured
      - Swap: Disabled for optimal performance