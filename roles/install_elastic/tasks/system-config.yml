---
# roles/install_elastic/tasks/system-config.yml
# System configuration for Elasticsearch

- name: Create Elasticsearch directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  loop:
    - "{{ elasticsearch_docker_path }}"
    - "{{ certs_base_path }}"

- name: Detect OS family
  set_fact:
    os_family: "{{ ansible_os_family | lower }}"

- name: Install Docker on RedHat/CentOS
  block:
    - name: Install Docker packages
      yum:
        name:
          - docker
          - docker-compose
        state: present
    - name: Install pip for Python Docker module
      yum:
        name: python3-pip
        state: present
    - name: Install Python Docker module
      pip:
        name: docker
  when: os_family in ['redhat', 'centos']

- name: Install Docker on Debian/Ubuntu
  block:
    - name: Update apt cache
      apt:
        update_cache: yes
    - name: Install Docker packages
      apt:
        name:
          - docker
          - docker-compose
        state: present
      ignore_errors: true
    - name: Install Docker alternative packages if first attempt fails
      apt:
        name:
          - docker.io
          - docker-compose
          - python3-docker
        state: present
      when: ansible_failed_result is defined
  when: os_family == 'debian'

- name: Install Docker using script if packages not available
  block:
    - name: Download Docker installation script
      get_url:
        url: https://get.docker.com
        dest: /tmp/get-docker.sh
        mode: '0755'
    - name: Install Docker using script
      shell: /tmp/get-docker.sh
    - name: Install docker-compose
      shell: |
        curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
  when: docker_install_failed is defined

- name: Start Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Add current user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes
  ignore_errors: true

- name: Test Docker installation
  shell: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  debug:
    msg: "Docker installed: {{ docker_version.stdout }}"

- name: Create Docker network for Elasticsearch
  shell: docker network create elastic --driver bridge --subnet=172.20.0.0/16 || echo "Network may already exist"
  ignore_errors: true

# System configuration
- name: Configure kernel parameters for Elasticsearch
  block:
    - name: Check current vm.max_map_count
      shell: sysctl -n vm.max_map_count
      register: current_max_map_count
      changed_when: false

    - name: Set vm.max_map_count using shell command
      shell: echo 262144 > /proc/sys/vm/max_map_count
      when: current_max_map_count.stdout != "262144"

    - name: Make vm.max_map_count persistent
      lineinfile:
        path: /etc/sysctl.conf
        regexp: '^vm\.max_map_count'
        line: 'vm.max_map_count=262144'
        create: yes
      when: current_max_map_count.stdout != "262144"

    - name: Set vm.swappiness
      shell: echo 1 > /proc/sys/vm/swappiness

    - name: Make vm.swappiness persistent
      lineinfile:
        path: /etc/sysctl.conf
        regexp: '^vm\.swappiness'
        line: 'vm.swappiness=1'
        create: yes

- name: Configure system limits for Elasticsearch
  blockinfile:
    path: /etc/security/limits.conf
    block: |
      # Elasticsearch limits
      * soft nofile 65536
      * hard nofile 65536
      * soft nproc 4096
      * hard nproc 4096
      * soft memlock unlimited
      * hard memlock unlimited
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Elasticsearch limits"

- name: Disable swap temporarily
  command: swapoff -a
  ignore_errors: true

- name: Display system configuration status
  debug:
    msg: |
      âœ… System Configuration Complete
      ==============================
      - Docker: {{ docker_version.stdout }}
      - Network: elastic network created
      - Kernel: vm.max_map_count set to 262144
      - Limits: File and memory limits configured
      - Swap: Disabled for optimal performance
