---
- name: "Multi-Node Elasticsearch Installation and Configuration"
  block:
    # Initialize deployment variables
    - name: Initialize deployment variables
      include_tasks: init-variables.yml

    # Skip hosts without Elasticsearch configuration
    - name: Skip hosts without Elasticsearch configuration
      meta: end_host
      when: 
        - not has_elasticsearch_nodes
        - hostvars[inventory_hostname].get('service_type', 'elasticsearch') == 'load_balancer'

    # Configure system for Elasticsearch
    - name: Configure system for Elasticsearch Docker
      include_tasks: system-config.yml
      when: has_elasticsearch_nodes

    # Build discovery configuration from inventory
    - name: Build discovery configuration
      include_tasks: build-discovery.yml
      when: has_elasticsearch_nodes

    # Configure /etc/hosts for hostname resolution
    - name: Configure hosts file
      include_tasks: configure-hosts.yml
      when: has_elasticsearch_nodes

    # Create complete directory structure
    - name: Create directory structure
      include_tasks: create-directories.yml
      when: has_elasticsearch_nodes

    # Setup SSL certificates
    - name: Setup SSL certificates for all nodes
      include_tasks: elasticsearch-ssl-setup.yml
      when: 
        - has_elasticsearch_nodes
        - (es_enable_http_ssl or es_enable_transport_ssl)

    # Generate node configurations
    - name: Generate Elasticsearch configurations
      include_tasks: generate-configs.yml
      when: has_elasticsearch_nodes

    # Setup and validate Docker Compose
    - name: Setup Docker Compose
      include_tasks: setup-docker-compose.yml
      when: has_elasticsearch_nodes

    # Deploy Elasticsearch
    - name: Deploy Elasticsearch using Docker Compose
      include_tasks: elasticsearch-docker-deploy.yml
      when: has_elasticsearch_nodes

    - name: Active License
      include_tasks: x-pack-activation.yml
      when: has_elasticsearch_nodes

  rescue:
    - name: Handle installation failure
      debug:
        msg: |
          Elasticsearch installation failed on {{ inventory_hostname }}!
          
          Diagnostic Steps:
          1. Check configuration files: ls -la {{ elasticsearch_docker_path }}/*/config/
          2. Check docker-compose syntax: cd {{ elasticsearch_docker_path }} && docker-compose config
          3. Check container logs: docker logs [container-name]
          4. Check system resources: free -h && df -h {{ elasticsearch_docker_path }}

  when: 
    - "'ELASTICSEARCH' in group_names"
    - "hostvars[inventory_hostname].get('elasticsearch_nodes', []) | length > 0"
  tags: [cluster, simple, elasticsearch]