---
- name: "ðŸš€ Multi-Node Elasticsearch Installation and Configuration"
  block:
    # STEP 1: Initialize and validate variables FIRST
    - name: Initialize deployment variables
      set_fact:
        # Set elasticsearch_nodes from inventory if not defined
        elasticsearch_nodes: "{{ hostvars[inventory_hostname].elasticsearch_nodes | default([]) }}"
        # Check if host has Elasticsearch nodes
        has_elasticsearch_nodes: "{{ (hostvars[inventory_hostname].elasticsearch_nodes | default([])) | length > 0 }}"

    - name: Skip hosts without Elasticsearch configuration
      meta: end_host
      when: 
        - not has_elasticsearch_nodes
        - hostvars[inventory_hostname].get('service_type', 'elasticsearch') == 'load_balancer'

    - name: Display node configuration
      debug:
        msg: |
          ðŸ“‹ Elasticsearch Configuration for {{ inventory_hostname }}:
          ==================================================
          Has elasticsearch_nodes: {{ has_elasticsearch_nodes }}
          Hostname: {{ hostvars[inventory_hostname].node_hostname }}
          Nodes to deploy: {{ elasticsearch_nodes | length }}
          {% for node in elasticsearch_nodes %}
          - {{ node.name }}: {{ node.roles | join(',') }} ({{ node.heap_size }})
          {% endfor %}
      when: has_elasticsearch_nodes

    # STEP 2: Set required variables
    - name: Set deployment configuration variables
      set_fact:
        # Paths - Using standardized structure
        elasticsearch_docker_path: "{{ elasticsearch_base_path }}"
        elasticsearch_compose_path: "{{ elasticsearch_base_path }}/docker-compose.yml"
        
        # Docker configuration
        elasticsearch_docker_image: "{{ elasticsearch_docker_image | default('docker.apk-group.net/elasticsearch') }}"
        es_version: "{{ es_version | default('8.18.2') }}"
        
        # Cluster configuration
        es_cluster_name: "{{ es_cluster_name | default('siem-cluster') }}"
        es_http_base_port: "{{ es_http_base_port | default(9200) | int }}"
        es_transport_base_port: "{{ es_transport_base_port | default(9300) | int }}"
        
        # SSL configuration
        es_enable_http_ssl: "{{ es_enable_http_ssl | default(true) }}"
        es_enable_transport_ssl: "{{ es_enable_transport_ssl | default(true) }}"
        es_ssl_certificate_path: "{{ certs_base_path }}"
        
        # Authentication
        es_api_basic_auth_username: "{{ es_api_basic_auth_username | default('elastic') }}"
        es_api_basic_auth_password: "{{ es_api_basic_auth_password | default('YourVerySecureElasticsearchPassword123!') }}"
      when: has_elasticsearch_nodes

    # STEP 3: Build cluster discovery configuration - UPDATED for hostnames
    - name: Build hostname-based discovery list
      set_fact:
        # Build list of seed hosts using hostnames and transport ports
        elasticsearch_seed_hosts_list: >-
          {{ groups['MASTER'] | map('extract', hostvars) | 
             selectattr('elasticsearch_nodes', 'defined') |
             map(attribute='elasticsearch_nodes') | flatten |
             selectattr('roles', 'contains', 'master') |
             map(attribute='name') |
             map('regex_replace', '^(.*)$', hostvars[inventory_hostname].node_hostname + ':' + (es_transport_base_port | string)) |
             list }}
        
        # Build list of master node names for initial cluster formation
        elasticsearch_master_node_names: >-
          {{ groups['MASTER'] | map('extract', hostvars) |
             selectattr('elasticsearch_nodes', 'defined') |
             map(attribute='elasticsearch_nodes') | flatten |
             selectattr('roles', 'contains', 'master') |
             map(attribute='name') | list }}
      when: has_elasticsearch_nodes

    - name: Build complete seed hosts list across all master hosts
      set_fact:
        elasticsearch_seed_hosts_list: >-
          {% set ns = namespace(hosts=[]) %}
          {% for host in groups['MASTER'] %}
          {%   if hostvars[host].elasticsearch_nodes is defined %}
          {%     for node in hostvars[host].elasticsearch_nodes %}
          {%       if 'master' in node.roles %}
          {%         set _ = ns.hosts.append(hostvars[host].node_hostname + ':' + ((es_transport_base_port | int) + (node.port_offset | int)) | string) %}
          {%       endif %}
          {%     endfor %}
          {%   endif %}
          {% endfor %}
          {{ ns.hosts }}
      when: has_elasticsearch_nodes

    - name: Create formatted seed hosts string
      set_fact:
        elasticsearch_seed_hosts: "{{ elasticsearch_seed_hosts_list | join(',') }}"
      when: has_elasticsearch_nodes

    - name: Display discovery configuration
      debug:
        msg: |
          ðŸ“‹ Discovery Configuration:
          Seed hosts: {{ elasticsearch_seed_hosts_list | join(', ') }}
          Master nodes: {{ elasticsearch_master_node_names | join(', ') }}
      when: has_elasticsearch_nodes

    # STEP 4: Configure /etc/hosts for hostname resolution
    - name: Add all cluster hosts to /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: "^{{ hostvars[item].ansible_host }}\\s+{{ hostvars[item].node_hostname }}"
        line: "{{ hostvars[item].ansible_host }} {{ hostvars[item].node_hostname }}"
        state: present
      loop: "{{ groups['ELASTICSEARCH'] }}"
      when: 
        - has_elasticsearch_nodes
        - hostvars[item].node_hostname is defined

    # STEP 5: Configure system for Elasticsearch
    - name: Configure system for Elasticsearch Docker
      include_tasks: system-config.yml
      when: has_elasticsearch_nodes

    # STEP 6: Create directory structure
    - name: Create Elasticsearch directory structure
      file:
        path: "{{ item }}"
        state: directory
        owner: "1000"
        group: "1000"
        mode: "0755"
      loop:
        - "{{ elasticsearch_docker_path }}"
        - "{{ certs_base_path }}"
      when: has_elasticsearch_nodes
        
    - name: Create node-specific directories
      file:
        path: "{{ elasticsearch_docker_path }}/{{ node.name }}/{{ dir_type }}"
        state: directory
        owner: "1000"
        group: "1000"
        mode: "0755"
      with_nested:
        - "{{ elasticsearch_nodes }}"
        - ["data", "logs", "config"]
      vars:
        node: "{{ item[0] }}"
        dir_type: "{{ item[1] }}"
      loop_control:
        label: "{{ node.name }}/{{ dir_type }}"
      when: has_elasticsearch_nodes

    # STEP 7: Setup SSL certificates with hostname SANs
    - name: Setup SSL certificates for all nodes
      include_tasks: elasticsearch-ssl-setup.yml
      when: 
        - has_elasticsearch_nodes
        - (es_enable_http_ssl or es_enable_transport_ssl)

    # STEP 8: Generate node configurations
    - name: Generate Elasticsearch configurations for each node
      template:
        src: elasticsearch-node.yml.j2
        dest: "{{ elasticsearch_docker_path }}/{{ node.name }}/config/elasticsearch.yml"
        owner: "1000"
        group: "1000"
        mode: "0644"
      loop: "{{ elasticsearch_nodes }}"
      loop_control:
        loop_var: node
        label: "{{ node.name }}"
      when: has_elasticsearch_nodes

    - name: Generate JVM options for each node
      template:
        src: jvm.options.j2
        dest: "{{ elasticsearch_docker_path }}/{{ node.name }}/config/jvm.options"
        owner: "1000"
        group: "1000"
        mode: "0644"
      loop: "{{ elasticsearch_nodes }}"
      loop_control:
        loop_var: node
        label: "{{ node.name }}"
      when: has_elasticsearch_nodes

    # STEP 9: Generate Docker Compose file
    - name: Generate Docker Compose file for multi-node deployment
      template:
        src: docker-compose-elasticsearch.yml.j2
        dest: "{{ elasticsearch_compose_path }}"
        mode: "0644"
        owner: root
        group: root
      register: compose_config
      when: has_elasticsearch_nodes

    # DEBUG: Display variables before template generation
    - name: Debug - Display template variables
      debug:
        msg: |
          ðŸ“‹ Docker Compose Template Variables:
          =====================================
          elasticsearch_docker_path: {{ elasticsearch_docker_path }}
          elasticsearch_compose_path: {{ elasticsearch_compose_path }}
          elasticsearch_nodes count: {{ elasticsearch_nodes | length }}
          elasticsearch_seed_hosts: {{ elasticsearch_seed_hosts }}
          elasticsearch_master_node_names: {{ elasticsearch_master_node_names | join(',') }}
          es_cluster_name: {{ es_cluster_name }}
          node_hostname: {{ hostvars[inventory_hostname].node_hostname }}
          
          Nodes to deploy:
          {% for node in elasticsearch_nodes %}
          - {{ node.name }}: roles={{ node.roles | join(',') }}, heap={{ node.heap_size }}, offset={{ node.port_offset }}
          {% endfor %}
      when: has_elasticsearch_nodes

    - name: Debug - Check if template file exists
      stat:
        path: "{{ role_path }}/templates/docker-compose-elasticsearch.yml.j2"
      register: template_exists
      when: has_elasticsearch_nodes

    - name: Debug - Display template check result
      debug:
        msg: |
          Template file check:
          Path: {{ role_path }}/templates/docker-compose-elasticsearch.yml.j2
          Exists: {{ template_exists.stat.exists | default('Unknown') }}
      when: has_elasticsearch_nodes

    # STEP 8: Generate Docker Compose file
    - name: Generate Docker Compose file for multi-node deployment
      template:
        src: docker-compose-elasticsearch.yml.j2
        dest: "{{ elasticsearch_compose_path }}"
        mode: "0644"
        owner: root
        group: root
      register: compose_config
      when: has_elasticsearch_nodes

    # Enhanced verification
    - name: Verify docker-compose file was created
      stat:
        path: "{{ elasticsearch_compose_path }}"
      register: compose_file_check
      when: has_elasticsearch_nodes

    - name: Display docker-compose file details
      debug:
        msg: |
          Docker Compose File Check:
          ==========================
          Path: {{ elasticsearch_compose_path }}
          Exists: {{ compose_file_check.stat.exists }}
          {% if compose_file_check.stat.exists %}
          Size: {{ compose_file_check.stat.size }} bytes
          Owner: {{ compose_file_check.stat.pw_name }}
          Mode: {{ compose_file_check.stat.mode }}
          {% endif %}
      when: has_elasticsearch_nodes

    - name: Show first 50 lines of docker-compose file if it exists
      shell: head -50 {{ elasticsearch_compose_path }}
      register: compose_content
      when: 
        - has_elasticsearch_nodes
        - compose_file_check.stat.exists
      changed_when: false
      ignore_errors: true

    - name: Display docker-compose content preview
      debug:
        msg: "{{ compose_content.stdout_lines }}"
      when:
        - has_elasticsearch_nodes
        - compose_file_check.stat.exists
        - compose_content is defined

    - name: Fail if docker-compose file was not created
      fail:
        msg: |
          âŒ Docker-compose file was not created!
          Expected path: {{ elasticsearch_compose_path }}
          
          Troubleshooting:
          1. Check if template exists at: roles/install_elastic/templates/docker-compose-elasticsearch.yml.j2
          2. Verify template syntax with: ansible-playbook --syntax-check
          3. Check template variables above
          4. Manual template test: ansible localhost -m template -a "src=roles/install_elastic/templates/docker-compose-elasticsearch.yml.j2 dest=/tmp/test-compose.yml"
      when: 
        - has_elasticsearch_nodes
        - not compose_file_check.stat.exists




    - name: Verify docker-compose file was created
      stat:
        path: "{{ elasticsearch_compose_path }}"
      register: compose_file_check
      when: has_elasticsearch_nodes

    - name: Fail if docker-compose file was not created
      fail:
        msg: |
          âŒ Docker-compose file was not created!
          Expected path: {{ elasticsearch_compose_path }}
          Please check template and variables.
      when: 
        - has_elasticsearch_nodes
        - not compose_file_check.stat.exists

    # STEP 10: Deploy Elasticsearch containers
    - name: Deploy Elasticsearch using Docker Compose
      include_tasks: elasticsearch-docker-deploy.yml
      when: has_elasticsearch_nodes

    # STEP 11: Verify cluster health
    - name: Verify cluster health
      include_tasks: wait-for-cluster.yml
      when: has_elasticsearch_nodes

    - name: Display completion message
      debug:
        msg: |
          âœ… Elasticsearch Installation Complete!
          =====================================
          
          Host: {{ inventory_hostname }} ({{ hostvars[inventory_hostname].node_hostname }})
          Nodes Deployed: {{ elasticsearch_nodes | length }}
          Network Mode: host
          
          ðŸ”— Access Points (using hostnames):
          {% for node in elasticsearch_nodes %}
          - {{ node.name }}: https://{{ hostvars[inventory_hostname].node_hostname }}:{{ es_http_base_port + node.port_offset }}
          {% endfor %}
          
          ðŸ”§ Management Commands:
          # View containers
          docker ps
          
          # View logs
          docker logs [node-name]
          
          # Check cluster health
          curl -k -u {{ es_api_basic_auth_username }}:PASSWORD \
            https://{{ hostvars[inventory_hostname].node_hostname }}:{{ es_http_base_port }}/_cluster/health
      when: has_elasticsearch_nodes

  rescue:
    - name: Handle installation failure
      debug:
        msg: |
          âŒ Elasticsearch installation failed on {{ inventory_hostname }}!
          
          Please check:
          1. Docker service: systemctl status docker
          2. Variables in inventory (especially node_hostname)
          3. /etc/hosts entries for hostname resolution
          4. Network connectivity between hosts
          5. Directory permissions
          6. Certificate generation
          
          For detailed troubleshooting, check the logs above.

  when: 
    - "'ELASTICSEARCH' in group_names"
    - "hostvars[inventory_hostname].get('elasticsearch_nodes', []) | length > 0"
  tags: [cluster, simple, elasticsearch]