input{\n  kafka{\n      id => \"kafka_out_windows\"\n      client_id => \"out_windows\"\n      bootstrap_servers => \"localhost:9094\"\n      auto_offset_reset => \"earliest\"\n      partition_assignment_strategy  => \"sticky\"\n      topics => \"in_windows\"\n      consumer_threads => 2\n      codec => \"json\"\n      add_field => { \"kafka_topic\" => \"in_windows\" }\n  }\n}\n\nfilter {\n\tif [event][original] and [message] {\n\t\tmutate {\n\t\t\tremove_field => [\"[event][original]\"]\n\t\t}\n\t}\n\tif [agent][type] == \"endpoint\" {\n\t\tmutate {\n\t\t\tadd_field => {\n\t\t\t\t\"[data_source][name]\" => \"endpoint\"\n\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t}\n\t\t}\n\t\t\n\t\tif [enrich_activator] {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\"[ioc][url]\" => false\n\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\"[ioc][email]\" => false\n\t\t\t\t\t\"[ioc][sha256]\" => false\n\t\t\t\t\t\"[ioc][sha1]\" => false\n\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\"[enrich][user_agent]\" => false\n\t\t\t\t\t\"[enrich][dga]\" => false\n\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\"[enrich][top_1m]\" => false\n\t\t\t\t\t\"[enrich][naked_ip]\" => false\n\t\t\t\t\t\"[enrich][url_length]\" => false\n\t\t\t\t\t\"[enrich][user_agent_length]\" => false\n\t\t\t\t\t\"[enrich][dns_question_name_length]\" => false\n\t\t\t\t\t\"[enrich][commiunity_id]\" => false\n\t\t\t\t\t\"[enrich][uri_part]\" => false\n\t\t\t\t\t\"[enrich][status_code]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {}\n\t}\n\n\telse if [agent][type] == \"packetbeat\" {\n\t\tmutate {\n\t\t\tadd_field => {\n\t\t\t\t\"[data_source][name]\" => \"packetbeat\"\n\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t}\n\t\t}\n\t\t\n\t\tif [enrich_activator] {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\"[ioc][url]\" => false\n\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\"[ioc][email]\" => false\n\t\t\t\t\t\"[ioc][sha256]\" => false\n\t\t\t\t\t\"[ioc][sha1]\" => false\n\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\"[enrich][user_agent]\" => false\n\t\t\t\t\t\"[enrich][dga]\" => false\n\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\"[enrich][top_1m]\" => false\n\t\t\t\t\t\"[enrich][naked_ip]\" => false\n\t\t\t\t\t\"[enrich][url_length]\" => false\n\t\t\t\t\t\"[enrich][user_agent_length]\" => false\n\t\t\t\t\t\"[enrich][dns_question_name_length]\" => false\n\t\t\t\t\t\"[enrich][commiunity_id]\" => false\n\t\t\t\t\t\"[enrich][uri_part]\" => false\n\t\t\t\t\t\"[enrich][status_code]\" => false\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {}\n\t}\n\n\telse {\n\t\tmutate { copy => { \"[data_stream][dataset]\" => \"[@metadata][dataset_name]\" } }\n\t\tmutate { split => { \"[@metadata][dataset_name]\" => \".\" } }\n\n\t\tif [@metadata][dataset_name][0] in [\"system\",\"windows\",\"winlog\"] {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[data_source][name]\" => \"windows\"\n\t\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif [enrich_activator] {\n\t\t\t\tmutate {\n\t\t\t\t\tadd_field => {\n\t\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\t\"[ioc][email]\" => false\n\t\t\t\t\t\t\"[ioc][sha256]\" => false\n\t\t\t\t\t\t\"[ioc][sha1]\" => false\n\t\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\t\"[enrich][dga]\" => false\n\t\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\t\"[enrich][top_1m]\" => false\n\t\t\t\t\t\t\"[enrich][dns_question_name_length]\" => false\n\t\t\t\t\t\t\"[enrich][commiunity_id]\" => false\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {}\n\t\t}\n\t\telse {\n\t\t\tmutate {\n\t\t\t\trename => { \"[@metadata][dataset_name][0]\" => \"[data_source][name]\" }\n\t\t\t}\n\t\t}\n\t\t\n\t\tif [data_source][name] == \"microsoft_dnsserver\" {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t\tif [enrich_activator] {\n\t\t\t\tmutate {\n\t\t\t\t\tadd_field => {\n\t\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\t\"[enrich][dga]\" => false\n\t\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\t\"[enrich][top_1m]\" => false\n\t\t\t\t\t\t\"[enrich][dns_question_name_length]\" => false\n\t\t\t\t\t\t\"[enrich][commiunity_id]\" => false\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {}\n\t\t}\n\t\telse if [data_source][name] == \"iis\" {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t\tif [enrich_activator] {\n\t\t\t\tmutate {\n\t\t\t\t\tadd_field => {\n\t\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\t\"[ioc][url]\" => false\n\t\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\t\"[enrich][user_agent]\" => false\n\t\t\t\t\t\t\"[enrich][dga]\" => false\n\t\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\t\"[enrich][top_1m]\" => false\n\t\t\t\t\t\t\"[enrich][naked_ip]\" => false\n\t\t\t\t\t\t\"[enrich][url_length]\" => false\n\t\t\t\t\t\t\"[enrich][user_agent_length]\" => false\n\t\t\t\t\t\t\"[enrich][commiunity_id]\" => false\n\t\t\t\t\t\t\"[enrich][uri_part]\" => false\n\t\t\t\t\t\t\"[enrich][status_code]\" => false\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {}\n\t\t}\n\t\telse if [data_source][name] == \"microsoft_exchange_server\" {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t\tif [enrich_activator] {\n\t\t\t\tmutate {\n\t\t\t\t\tadd_field => {\n\t\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\t\"[ioc][url]\" => false\n\t\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\t\"[ioc][email]\" => false\n\t\t\t\t\t\t\"[ioc][sha256]\" => false\n\t\t\t\t\t\t\"[ioc][sha1]\" => false\n\t\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\t\"[enrich][user_agent]\" => false\n\t\t\t\t\t\t\"[enrich][dga]\" => false\n\t\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\t\"[enrich][top_1m]\" => false\n\t\t\t\t\t\t\"[enrich][naked_ip]\" => false\n\t\t\t\t\t\t\"[enrich][url_length]\" => false\n\t\t\t\t\t\t\"[enrich][user_agent_length]\" => false\n\t\t\t\t\t\t\"[enrich][commiunity_id]\" => false\n\t\t\t\t\t\t\"[enrich][uri_part]\" => false\n\t\t\t\t\t\t\"[enrich][status_code]\" => false\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {}\n\t\t}\n\t\telse if [data_source][name] == \"microsoft_sqlserver\" {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t\tif [enrich_activator] {\n\t\t\t\tmutate {\n\t\t\t\t\tadd_field => {\n\t\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\t\"[enrich][commiunity_id]\" => false\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {}\n\t\t}\n\t\telse if [data_source][name] == \"microsoft_dhcp\" {\n\t\t\tmutate {\n\t\t\t\tadd_field => {\n\t\t\t\t\t\"[enrich_activator]\" => false\n\t\t\t\t}\n\t\t\t}\n\t\t\tif [enrich_activator] {\n\t\t\t\tmutate {\n\t\t\t\t\tadd_field => {\n\t\t\t\t\t\t\"[ioc][ip]\" => false\n\t\t\t\t\t\t\"[ioc][domain]\" => false\n\t\t\t\t\t\t\"[enrich][network_direction]\" => false\n\t\t\t\t\t\t\"[enrich][tld]\" => false\n\t\t\t\t\t\t\"[enrich][geo]\" => false\n\t\t\t\t\t\t\"[enrich][commiunity_id]\" => false\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {}\n\t\t}\n\t\telse {}\n\t}\n\n  \t# Do not activate below line\n\t#if [message] { fingerprint { source => [\"message\"] method => \"MD5\" key => \"${HMAC_SALT:APKS!em}\" target => \"event.hash\" } }\n}\n\noutput{\n  elasticsearch {\n    hosts => [{% for host in groups['SF'] %}\"https://{{ hostvars[host]['ansible_host'] }}:9200\"{% if not loop.last %},{% endif %}{% endfor %}]\n    api_key => \"{{ logstash_api_key }}\"\n    data_stream => true\n    ssl => true\n    ssl_certificate_verification => false\n  }\n}