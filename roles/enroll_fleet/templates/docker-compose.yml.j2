version: "3"
services:
  fleet_server:
    image: "{{ docker_image_name }}:{{ docker_image_tag }}"
    container_name: "elastic_fleet_server"
    restart: always
    user: root
    environment:
      - FLEET_SERVER_ENABLE=true
      - FLEET_SERVER_ELASTICSEARCH_HOST=https://{{ ansible_default_ipv4.address }}:9200
      - FLEET_SERVER_ELASTICSEARCH_CA=/opt/certs/elasticsearch-ca.crt
      - FLEET_SERVER_SERVICE_TOKEN={{ es_service_token_fleet }}
      - FLEET_SERVER_ELASTICSEARCH_CA_TRUSTED_FINGERPRINT={{ cert_fingerprint }}
      - FLEET_SERVER_POLICY_ID=fleet-server-policy
      - FLEET_INSECURE=true
      - FLEET_SERVER_PORT=8222
      - FLEET_ENROLE=1
    hostname: "Fleet-Server"
    volumes:
      - /etc/elasticsearch/certs/ca/ca.crt:/opt/certs/elasticsearch-ca.crt
    ports:
      - 8222:8222