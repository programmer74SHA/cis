- name: create fleet server hosts in kibana
  uri:
    url: "{{ kibana_address }}/api/fleet/outputs"
    method: POST
    body: "{{ lookup('template', 'templates/logstash_outputs/{{ item }}') }}"
    body_format: json
    headers:
      Content-Type: application/json
      kbn-xsrf: "true"
    user: "{{ elk_user }}"
    password: "{{ elk_password }}"
    validate_certs: no
    force_basic_auth: yes
  register: fleet_output
  failed_when: fleet_output.status not in [200, 201, 409]
  with_items:
    - "agentbase-output.json.j2"
    - "agentless-output.json.j2"
    - "nba-output.json.j2"