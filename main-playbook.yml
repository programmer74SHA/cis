---
- name: "APK SIEM ELK Cluster Installer - Fixed & Simplified Version"
  hosts: all
  serial: "{{ ansible_serial | default('100%') }}"
  gather_facts: true
  
  pre_tasks:
    - name: Set deployment facts
      set_fact:
        deployment_start_time: "{{ ansible_date_time.iso8601 }}"
        
    - name: Display deployment banner
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              APK SIEM ELK CLUSTER DEPLOYMENT                 â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Host: {{ inventory_hostname }}                               â•‘
          â•‘ IP: {{ ansible_default_ipv4.address }}                       â•‘
          â•‘ Groups: {{ group_names | join(', ') }}                       â•‘
          â•‘ Start Time: {{ deployment_start_time }}                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
  roles:
    # Pre-flight checks
    - role: pre_checks
      tags: [always]
    
    # Node identification
    - role: add-new-node
      tags: [always]
    
    # Install Elasticsearch on all nodes with elasticsearch_nodes defined
    # - role: install_elastic
    #   when: >
    #     ('ELASTICSEARCH' in group_names) and 
    #     (hostvars[inventory_hostname].get('elasticsearch_nodes', []) | length > 0)
    #   tags: [cluster, simple, elasticsearch]
    
    # Install Kibana only on BDA nodes
    - role: install_kibana
      when: >
        ('BDA' in group_names) and 
        (hostvars[inventory_hostname].get('install_kibana', false) | bool)
      tags: [cluster, simple, kibana]
    
  # post_tasks:
  #   - name: Display deployment completion status
  #     debug:
  #       msg: |
  #         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  #         â•‘                DEPLOYMENT COMPLETED SUCCESSFULLY             â•‘
  #         â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  #         â•‘ Host: {{ inventory_hostname }}                               â•‘
  #         â•‘ Start Time: {{ deployment_start_time }}                      â•‘
  #         â•‘ End Time: {{ ansible_date_time.iso8601 }}                    â•‘
  #         â•‘                                                              â•‘
  #         â•‘ Services Deployed:                                           â•‘
  #         {% if hostvars[inventory_hostname].get('elasticsearch_nodes', []) | length > 0 %}
  #         â•‘ âœ… Elasticsearch: {{ hostvars[inventory_hostname].get('elasticsearch_nodes', []) | length }} nodes â•‘
  #         {% endif %}
  #         {% if 'BDA' in group_names and hostvars[inventory_hostname].get('install_kibana', false) %}
  #         â•‘ âœ… Kibana: Management Interface                              â•‘
  #         {% endif %}
  #         â•‘                                                              â•‘
  #         â•‘ Access Information:                                          â•‘
  #         {% if hostvars[inventory_hostname].get('elasticsearch_nodes', []) | length > 0 %}
  #         â•‘ ðŸ”— Elasticsearch: https://{{ ansible_default_ipv4.address }}:9200  â•‘
  #         {% endif %}
  #         {% if 'BDA' in group_names and hostvars[inventory_hostname].get('install_kibana', false) %}
  #         â•‘ ðŸ”— Kibana: https://{{ ansible_default_ipv4.address }}:5601          â•‘
  #         â•‘ ðŸ‘¤ Username: elastic                                         â•‘
  #         â•‘ ðŸ”‘ Password: [Check inventory file]                          â•‘
  #         {% endif %}
  #         â•‘                                                              â•‘
  #         â•‘ Management Commands:                                         â•‘
  #         â•‘ # Verify cluster health:                                     â•‘
  #         â•‘ curl -k -u elastic:PASSWORD \                               â•‘
  #         â•‘   https://{{ ansible_default_ipv4.address }}:9200/_cluster/health        â•‘
  #         â•‘                                                              â•‘
  #         â•‘ # Check containers:                                          â•‘
  #         â•‘ docker ps                                                    â•‘
  #         â•‘                                                              â•‘
  #         â•‘ # View logs:                                                 â•‘
  #         â•‘ docker logs [container-name]                                â•‘
  #         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #     when: >
  #       (inventory_hostname in groups.get('BDA', [])) or 
  #       (inventory_hostname in groups.get('ELASTICSEARCH', []))
        
  #   - name: Create cluster verification script
  #     template:
  #       src: cluster-verification.sh.j2
  #       dest: "{{ siem_base_path }}/cluster-verification.sh"
  #       mode: "0755"
  #       owner: root
  #       group: root
  #     when: inventory_hostname in groups.get('BDA', [])
      
  # tags: [cluster, simple]